## Tasks

Tasks framework. Automatic tasks creation from mission config. All scripts, conditions and events are run on server only.

## Table of Contents

- [Tasks](#tasks)
- [Table of Contents](#table-of-contents)
- [How to use](#how-to-use)
- [Example config](#example-config)
- [Using stringtable](#using-stringtable)
  - [Autogenerated stringtable references](#autogenerated-stringtable-references)
  - [Autogenerated stringtable references with TAG](#autogenerated-stringtable-references-with-tag)
- [Example custom event handling](#example-custom-event-handling)
- [Framework events](#framework-events)
- [Authors](#authors)

## How to use

Just create `CfgTasks` in your mission's `description.ext` and fill it with tasks! Yes, and that's it, no more linking modules and triggers into spaghetti, works out of the box.

If you don't want to use some property it is best to remove it at all, don't leave it empty, it can break things sometimes.

## Example config

```hpp
class CfgTasks {
    /* Optional tag specification. Used for automatic title/description stringtable references.
    For e.g., "MyMission", the autogenerated stringtable refrences will be "STR_MyMission_Task_TASKNAME_Title" and "STR_MyMission_Task_TASKNAME_Description".
    When omitted or empty, the references will be "STR_Task_TASKNAME_Title" and "STR_Task_TASKNAME_Description".
    For more details please look at "Using Stringtable" section in README.
    */
    tag = "";

    class Soapy_Mission_XD {
        title = "Soapy Mission XD - Horse Knocked"; // Regular task title
        description = "Great mission of beating horse."; // Regular description. Cannot use linebreaks (enters), if needed use stringtable.
        tag = ""; // Optional CfgTasks.tag override for task. When omitted, fallback to global tag will be performed. If defined as empty, global tag will be ignored.
        /* Task icon location on the map
        First checks for marker with given name, and if doesn't exists, checks for object in mission namespace.
        Alternatively {x, y, z} can be used for supplying position coordinates.
        If all of them are empty then task won't be shown on the map. */
        position[] = {}; // Use for position
        object = ""; // Use for objects
        marker = ""; // Use for marker names only
        icon = "unknown"; // Icon classname from https://community.bistudio.com/wiki/Arma_3:_Task_Framework#Task_icons

        owners[] = { "true" }; // Default value, use "All"/"true" for all playable units
        ownersCode = ""; // Default value, code executed when task show conditions apply, returned value overwrites 'owners', ignored if returns nil

        initialState = "CREATED"; // Default value
        priority = -1; // Default value
        createdShowNotification = "false"; // Default value
        visibleIn3D = "false"; // Default value

        parentTask = ""; // Config entry name of parent task

        // Showing/creating task
        conditionCodeShow = "true";
        conditionEventsShow[] = {}; // Default value for all conditionEvents*[] is equal to [] which is {} in config
        conditionEventsShowRequired = 1; // How many events must fire for events condition to be met

        // Conditions codes which must return true to finish task
        conditionCodeSuccess = "";
        conditionCodeFailed = "";
        conditionCodeCanceled = "";
        // CBA event names which must be triggered to achieve the same as above
        conditionEventsSuccess[] = {};
        conditionEventsFailed[] = {};
        conditionEventsCanceled[] = {};
        // And number required as in show but for all others
        conditionEventsSuccessRequired = 1;
        conditionEventsFailedRequired = 1;
        conditionEventsCanceledRequired = 1;

        // Server CBA events called. If you want custom code just add appropriate CBA EH on server.
        onShowEvents[] = {};
        onSuccessEvents[] = {};
        onFailedEvents[] = {};
        onCanceledEvents[] = {};
    };
    class FindHorse {
        title = "Find Horse";
        icon = "search";
        parentTask = "Soapy_Mission_XD";
        conditionCodeShow = "true";
        conditionCodeSuccess = "unit1 distance horse < 50";
        onSuccessEvents[] = { "horseFound" };
    };
    class KnockHorse {
        title = "Knock Horse";
        icon = "attack";
        object = "horse";
        parentTask = "FindHorse";

        // Will add this tasks only for players with "isHorseKnocker" variable set to true
        ownersCode = "allPlayers select {_x getVariable ['isHorseKnocker', false]}";

        conditionEventsShow[] = { "horseFound" };
        conditionCodeSuccess = "!(alive horse)";
        conditionCodeFailed = "!(alive unit1)";

        onSuccessEvents[] = { "horseKnocked" };
        onFailedEvents[] = { "playerDied" };
    };
};
```

## Using stringtable

When using stringtable make sure your config entry doesn't start with `$`:

```hpp
// Bad - it will be localized in config
title = $STR_TAG_TaskOneTitle;

// Good - it will be unchanged and can be loaded and localized by scripts
title = "STR_TAG_TaskOneTitle";
```

If using CBA macros use `LSTRING()` instead of `CSTRING()`. Otherwise localization will be performed on the server, before tasks configuration is read.

### Autogenerated stringtable references

You may choose to omit title/description definition and use autogenerated stringtable keys:

```hpp
class CfgTasks {
    class TASKCLASSNAME {
        icon = "attack";
    };
};
```

Framework will look for the keys below:

- `STR_Task_TASKCLASSNAME_Title`
- `STR_Task_TASKCLASSNAME_Description`

Effectively, this will behave the same as (with one exception):

```hpp
class CfgTasks {
    class TASKCLASSNAME {
        title = "STR_Task_TASKCLASSNAME_Title";
        description = "STR_Task_TASKCLASSNAME_Description";
        icon = "attack";
    };
};
```

The one exception being class inheritance. If you want to inherit title or description, you must specify it manually (so nothing really changes here). In case you don't want to inherit it (like me in 90% cases), you have a lot less code to write.

### Autogenerated stringtable references with TAG

You may also want to include TAG in your stringtable reference. It can be defined on `CfgTasks` level or at the task level (in case you need to override global tag).

```hpp
class CfgTasks {
    tag = "MySuperMission";

    class TASKCLASSNAME {
        icon = "attack";
    };

    class OTHERTAGTASKCLASSNAME {
        tag = "MyOtherMission";
        icon = "defend";
    };
};
```

This will result in the following keys expected:

- `STR_MySuperMission_Task_TASKCLASSNAME_Title`
- `STR_MySuperMission_Task_TASKCLASSNAME_Description`
- `STR_MyOtherMission_Task_OTHERTAGTASKCLASSNAME_Title`
- `STR_MyOtherMission_Task_OTHERTAGTASKCLASSNAME_Description`

## Example custom event handling

```SQF
// initServer.sqf

// Event handler for onSuccessEvent
["horseKnocked", {
    titleText ["You beat the horse!", "PLAIN DOWN", 0.5];
    [{
        "EveryoneWon" call BIS_fnc_endMission;
    }, [], 3] call CBA_fnc_waitAndExecute;
}] call CBA_fnc_addEventHandler;

// Event handler for onFailedEvent
["playerDied", {
    titleText ["You died!", "PLAIN DOWN", 0.5];
    [{
        "EveryoneLost" call BIS_fnc_endMission;
    }, [], 3] call CBA_fnc_waitAndExecute;
}] call CBA_fnc_addEventHandler;
```

## Framework events

```
Event "afm_tasks_taskCreated"
  Params
  - 0: Task config name <STRING>
Event "afm_tasks_taskStateChanged"
  Params
  - 0: Task config name <STRING>
  - 1: New task state <STRING>
```

## Authors

- [3Mydlo3](http://github.com/3Mydlo3)
